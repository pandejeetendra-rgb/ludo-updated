<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cyber Ludo Quiz (Model B) ‚Äî Hardwired MCQs</title>

<style>
  :root{
    --bg1:#0b1020; --bg2:#0b2a55;
    --stroke: rgba(255,255,255,.18);
    --text:#f7fbff; --muted: rgba(247,251,255,.75);

    --green:#16a34a;
    --yellow:#facc15;
    --red:#ef4444;
    --blue:#2563eb;

    --p1:#34d399;   /* learner token */
    --p2:#fb7185;   /* computer token */

    --shadow: 0 12px 35px rgba(0,0,0,.35);
    --radius: 18px;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--text);
    min-height:100vh;
    background:
      radial-gradient(1200px 700px at 15% 10%, rgba(96,165,250,.35), transparent 60%),
      radial-gradient(900px 700px at 85% 20%, rgba(52,211,153,.25), transparent 55%),
      radial-gradient(900px 700px at 80% 90%, rgba(251,113,133,.22), transparent 60%),
      linear-gradient(160deg, var(--bg1), var(--bg2));
  }

  .wrap{
    max-width: 1200px;
    margin: 0 auto;
    padding: 14px;
    display:grid;
    grid-template-columns: 1fr;
    gap: 14px;
  }

  .topbar{
    display:flex; align-items:center; justify-content:space-between;
    gap:12px;
    padding: 12px 14px;
    border:1px solid var(--stroke);
    border-radius: var(--radius);
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
    box-shadow: var(--shadow);
  }

  .brand{ display:flex; align-items:center; gap:10px; min-width: 0; }
  .logo{
    width:38px; height:38px; border-radius:12px;
    background:
      radial-gradient(circle at 30% 35%, rgba(255,255,255,.55), transparent 45%),
      linear-gradient(135deg, rgba(96,165,250,.9), rgba(52,211,153,.9));
    box-shadow: 0 10px 20px rgba(0,0,0,.25);
    flex: 0 0 auto;
  }
  .brand h1{
    font-size: 15px; margin:0; line-height:1.2; letter-spacing:.2px;
    white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
  }
  .brand p{ margin:2px 0 0; font-size: 12px; color: var(--muted); }

  .actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }

  button{
    border: 1px solid var(--stroke);
    background: rgba(255,255,255,.10);
    color: var(--text);
    padding: 10px 12px;
    border-radius: 14px;
    cursor:pointer;
    transition: transform .08s ease, background .15s ease, border-color .15s ease;
    font-weight: 800;
    letter-spacing:.15px;
  }
  button:hover{ background: rgba(255,255,255,.14); }
  button:active{ transform: scale(.98); }
  button.primary{
    border-color: rgba(96,165,250,.55);
    background: linear-gradient(180deg, rgba(96,165,250,.30), rgba(96,165,250,.18));
  }
  button.good{
    border-color: rgba(34,197,94,.55);
    background: linear-gradient(180deg, rgba(34,197,94,.25), rgba(34,197,94,.12));
  }
  button.danger{
    border-color: rgba(239,68,68,.55);
    background: linear-gradient(180deg, rgba(239,68,68,.22), rgba(239,68,68,.10));
  }
  button:disabled{ opacity:.55; cursor:not-allowed; }

  .card{
    border:1px solid var(--stroke);
    border-radius: var(--radius);
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .card .hd{
    padding: 12px 14px;
    border-bottom: 1px solid rgba(255,255,255,.10);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .card .hd .ttl{ font-weight: 950; letter-spacing:.2px; }
  .card .hd .sub{ font-size:12px; color:var(--muted); }
  .card .bd{ padding: 14px; }

  .screen{ display:none; }
  .screen.active{ display:block; }

  /* Quiz */
  .qText{
    font-size: 16px; font-weight: 950;
    line-height: 1.35; margin: 0 0 12px;
  }
  .optGrid{ display:grid; grid-template-columns: 1fr; gap: 10px; }
  .optBtn{
    text-align:left;
    font-weight: 850;
    padding: 12px 12px;
    border-radius: 16px;
    background: rgba(255,255,255,.08);
  }
  .optBtn .lab{
    display:inline-flex;
    width: 30px; height: 30px;
    align-items:center; justify-content:center;
    border-radius: 12px;
    margin-right: 10px;
    font-weight: 950;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.18);
  }
  .optBtn:hover{ background: rgba(255,255,255,.12); }
  .note{ font-size: 12px; color: var(--muted); line-height: 1.5; }

  /* Board wrapper */
  .boardWrap{ display:flex; flex-direction: column; gap: 12px; }
  .boardTopInfo{
    display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
    flex-wrap:wrap;
  }
  .pill{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.07);
    border-radius: 16px;
    padding: 10px 12px;
  }
  .pill .k{ font-size:12px; color: var(--muted); }
  .pill .v{ font-size: 15px; font-weight: 950; margin-top: 2px; }

  /* Ludo-like frame */
  .board{
    width: min(580px, 100%);
    aspect-ratio: 1 / 1;
    margin: 0 auto;
    border-radius: 28px;
    position: relative;
    overflow:hidden;
    background: linear-gradient(180deg, rgba(255,220,140,.95), rgba(255,165,40,.92));
    box-shadow: 0 18px 45px rgba(0,0,0,.40);
    padding: 10px;
  }
  .board::before{
    content:"";
    position:absolute;
    inset:10px;
    border-radius: 22px;
    background: rgba(255,255,255,.98);
    box-shadow:
      inset 0 10px 18px rgba(255,255,255,.55),
      inset 0 -10px 18px rgba(0,0,0,.12);
    z-index: 0;
  }

  .boardBg{
    position:absolute;
    inset:10px;
    width:calc(100% - 20px);
    height:calc(100% - 20px);
    z-index: 1;
  }

  .track{
    position:absolute;
    inset:28px;
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    grid-template-rows: repeat(7, 1fr);
    gap: 6px;
    z-index: 2;
  }

  .cell{
    border-radius: 14px;
    border: 1px solid rgba(0,0,0,.14);
    background:
      radial-gradient(circle at 30% 25%, rgba(255,255,255,.98), rgba(245,245,245,.92));
    position: relative;
    overflow:hidden;
    box-shadow: 0 3px 8px rgba(0,0,0,.12);
  }

  .badge{
    position:absolute; top:7px; left:7px;
    font-size: 11px;
    color: rgba(0,0,0,.65);
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid rgba(0,0,0,.15);
    background: rgba(255,255,255,.82);
    z-index: 2;
  }

  .cell.start{
    border-color: rgba(37,99,235,.35);
    background:
      radial-gradient(circle at 30% 25%, rgba(96,165,250,.55), rgba(255,255,255,.92));
  }
  .cell.finish{
    border-color: rgba(22,163,74,.35);
    background:
      radial-gradient(circle at 30% 25%, rgba(34,197,94,.45), rgba(255,255,255,.92));
  }

  .cell.safe{
    border-color: rgba(245,158,11,.55);
  }
  .cell.safe::after{
    content:"‚òÖ";
    position:absolute;
    right:8px; top:6px;
    font-size: 14px;
    color: rgba(245,158,11,.95);
    text-shadow: 0 2px 4px rgba(0,0,0,.25);
    z-index: 2;
  }

  .tokens{
    position:absolute; right:8px; bottom:8px;
    display:flex; gap:6px;
    z-index: 3;
  }

  .token{
    width: 22px; height: 22px;
    border-radius: 9px;
    border: 2px solid rgba(255,255,255,.95);
    box-shadow: 0 10px 20px rgba(0,0,0,.35);
    position: relative;
  }
  .token::after{
    content:"";
    position:absolute; inset:3px;
    border-radius: 7px;
    background: rgba(255,255,255,.18);
    mix-blend-mode: screen;
  }
  .t1{ background: linear-gradient(135deg, rgba(52,211,153,.95), rgba(16,185,129,.85)); }
  .t2{ background: linear-gradient(135deg, rgba(251,113,133,.95), rgba(244,63,94,.85)); }

  .glowP1{ box-shadow: 0 0 0 3px rgba(52,211,153,.25), 0 0 18px rgba(52,211,153,.30) inset; }
  .glowP2{ box-shadow: 0 0 0 3px rgba(251,113,133,.22), 0 0 18px rgba(251,113,133,.28) inset; }
  .hop{ animation: hop .18s ease-out 1; }
  @keyframes hop{
    0%{ transform: translateY(0) scale(1); }
    50%{ transform: translateY(-6px) scale(1.06); }
    100%{ transform: translateY(0) scale(1); }
  }

  /* FX overlay */
  .fxLayer{
    position:absolute;
    inset:28px;
    pointer-events:none;
    z-index: 5;
  }

  .trailDot{
    position:absolute;
    width: 14px; height: 14px;
    border-radius: 999px;
    transform: translate(-50%, -50%);
    opacity:.95;
    animation: trailFade .42s ease-out forwards;
  }
  @keyframes trailFade{
    0%{ opacity:.85; transform: translate(-50%, -50%) scale(1); }
    100%{ opacity:0; transform: translate(-50%, -50%) scale(.35); }
  }

  .sparkWrap{
    position:absolute;
    width: 1px; height: 1px;
    transform: translate(-50%, -50%);
  }
  .spark{
    position:absolute;
    width: 6px; height: 6px;
    border-radius: 999px;
    opacity: .95;
    animation: sparkFly .50s ease-out forwards;
  }
  @keyframes sparkFly{
    0%{ transform: translate(0,0) scale(1); opacity:.95; }
    100%{ transform: translate(var(--dx), var(--dy)) scale(.45); opacity:0; }
  }

  /* Small UI dice (panel) */
  .diceRow{
    display:flex; align-items:center; gap: 10px; justify-content:space-between;
    flex-wrap:wrap;
  }
  .dice{
    width: 58px; height: 58px;
    border-radius: 16px;
    border: 1px solid rgba(0,0,0,.15);
    background:
      radial-gradient(circle at 30% 25%, rgba(255,255,255,.95), rgba(235,235,235,.90));
    box-shadow: 0 14px 26px rgba(0,0,0,.35);
    display:flex; align-items:center; justify-content:center;
    font-size: 22px; font-weight: 950;
    user-select:none;
    position: relative;
  }
  .dice.rolling{ animation: diceRoll .35s linear infinite; }
  @keyframes diceRoll{
    0%{ transform: rotate(0deg) scale(1); }
    50%{ transform: rotate(180deg) scale(1.05); }
    100%{ transform: rotate(360deg) scale(1); }
  }

  /* Big center dice (board) */
  #centerDice{
    position:absolute;
    left:50%; top:50%;
    width: 140px; height: 140px;
    transform: translate(-50%,-50%) rotate(12deg);
    border-radius: 28px;
    background:
      radial-gradient(circle at 30% 25%, rgba(255,255,255,.98), rgba(230,230,230,.92));
    box-shadow:
      0 22px 40px rgba(0,0,0,.35),
      inset 0 10px 18px rgba(255,255,255,.65),
      inset 0 -10px 18px rgba(0,0,0,.10);
    opacity: 0;
    pointer-events:none;
    z-index: 4;
    transition: opacity .18s ease;
  }
  #centerDice.show{ opacity: 1; }
  #centerDice.rolling{ animation: centerDiceRoll .35s linear infinite; }
  @keyframes centerDiceRoll{
    0%{ transform: translate(-50%,-50%) rotate(12deg) scale(1); }
    50%{ transform: translate(-50%,-50%) rotate(192deg) scale(1.04); }
    100%{ transform: translate(-50%,-50%) rotate(372deg) scale(1); }
  }
  .pip{
    position:absolute;
    width: 14px; height: 14px;
    border-radius: 999px;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), rgba(30,30,30,1));
    box-shadow: inset 0 2px 4px rgba(255,255,255,.15);
    opacity:0;
  }
  #centerDice.face1 .p5{opacity:1;}
  #centerDice.face2 .p1,#centerDice.face2 .p9{opacity:1;}
  #centerDice.face3 .p1,#centerDice.face3 .p5,#centerDice.face3 .p9{opacity:1;}
  #centerDice.face4 .p1,#centerDice.face4 .p3,#centerDice.face4 .p7,#centerDice.face4 .p9{opacity:1;}
  #centerDice.face5 .p1,#centerDice.face5 .p3,#centerDice.face5 .p5,#centerDice.face5 .p7,#centerDice.face5 .p9{opacity:1;}
  #centerDice.face6 .p1,#centerDice.face6 .p3,#centerDice.face6 .p4,#centerDice.face6 .p6,#centerDice.face6 .p7,#centerDice.face6 .p9{opacity:1;}

  /* pip positions (3x3) */
  .p1{left:26px; top:26px;}
  .p2{left:63px; top:26px;}
  .p3{left:100px; top:26px;}
  .p4{left:26px; top:63px;}
  .p5{left:63px; top:63px;}
  .p6{left:100px; top:63px;}
  .p7{left:26px; top:100px;}
  .p8{left:63px; top:100px;}
  .p9{left:100px; top:100px;}

  /* Modal */
  .overlay{
    position: fixed; inset: 0;
    background: rgba(0,0,0,.55);
    display:none;
    align-items:center; justify-content:center;
    padding: 18px;
    z-index: 999;
  }
  .modal{
    width: min(680px, 100%);
    border-radius: 22px;
    border: 1px solid rgba(255,255,255,.18);
    background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.08));
    box-shadow: 0 18px 50px rgba(0,0,0,.45);
    overflow:hidden;
  }
  .modal .mhd{
    padding: 14px 16px;
    border-bottom: 1px solid rgba(255,255,255,.10);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .modal .mhd .mt{ font-weight: 950; }
  .modal .mbd{ padding: 16px; color: rgba(247,251,255,.92); }

  .kbd{ display:grid; gap: 10px; margin-top: 10px; }
  .kbd div{
    padding: 10px 12px;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    color: rgba(247,251,255,.92);
    font-size: 13px;
    line-height: 1.45;
  }

  .bigPop{
    position: fixed; left: 50%; top: 14%;
    transform: translateX(-50%);
    padding: 12px 18px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.22);
    background: rgba(0,0,0,.30);
    backdrop-filter: blur(8px);
    font-weight: 950; letter-spacing:.3px;
    display:none; z-index: 998;
    box-shadow: 0 18px 45px rgba(0,0,0,.35);
  }
  .bigPop.ok{ color: rgba(34,197,94,.95); }
  .bigPop.bad{ color: rgba(239,68,68,.95); }

  .shake{ animation: shake .25s linear 1; }
  @keyframes shake{
    0%{ transform: translate(0,0); }
    20%{ transform: translate(-5px, 2px); }
    40%{ transform: translate(4px, -3px); }
    60%{ transform: translate(-3px, 1px); }
    80%{ transform: translate(3px, 2px); }
    100%{ transform: translate(0,0); }
  }

  #confetti{
    position: fixed;
    inset: 0;
    width: 100vw;
    height: 100vh;
    pointer-events: none;
    z-index: 1200;
    display:none;
  }
</style>
</head>

<body>
<canvas id="confetti"></canvas>

<div class="wrap" id="app">

  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div style="min-width:0">
        <h1>Cyber Ludo Quiz (Model B) ‚Äî Hardwired MCQs</h1>
        <p>MCQ screen ‚Üí Board animation ‚Üí next MCQ (mobile friendly)</p>
      </div>
    </div>
    <div class="actions">
      <button class="primary" id="btnHow">How to Play</button>
      <button class="danger" id="btnRestart">Restart</button>
    </div>
  </div>

  <!-- SCREEN 1: MCQ ONLY -->
  <div class="card screen active" id="mcqScreen">
    <div class="hd">
      <div>
        <div class="ttl">Quiz Turn</div>
        <div class="sub">Answer MCQ first. Then board animation will be shown.</div>
      </div>
      <button class="good" id="btnSkip">Skip (No Move)</button>
    </div>
    <div class="bd">
      <p class="qText" id="qText">Loading‚Ä¶</p>
      <div class="optGrid" id="opts"></div>
      <div class="note" style="margin-top:12px">
        Correct ‚Üí dice rolls and you move ‚Ä¢ Wrong ‚Üí computer moves +2
      </div>
    </div>
  </div>

  <!-- SCREEN 2: BOARD ONLY -->
  <div class="card screen" id="boardScreen">
    <div class="hd">
      <div>
        <div class="ttl">Board Animation</div>
        <div class="sub">Classic Ludo-style board (mobile friendly).</div>
      </div>
      <div class="note" id="animHint" style="font-weight:900;color:rgba(247,251,255,.9);">Waiting‚Ä¶</div>
    </div>
    <div class="bd">
      <div class="boardWrap">

        <div class="boardTopInfo">
          <div class="pill">
            <div class="k">Learner</div>
            <div class="v"><span style="color:var(--p1)">‚óè</span> <span id="p1Pos">0</span> / <span id="maxPos">0</span></div>
          </div>
          <div class="pill">
            <div class="k">Computer</div>
            <div class="v"><span style="color:var(--p2)">‚óè</span> <span id="p2Pos">0</span> / <span id="maxPos2">0</span></div>
          </div>
          <div class="pill">
            <div class="k">Dice</div>
            <div class="diceRow">
              <div class="dice" id="dice">‚Äî</div>
              <div class="note" id="statusText" style="max-width:220px">Waiting‚Ä¶</div>
            </div>
            <div class="note" id="statusSub" style="margin-top:6px">Safe squares spark. HOME gives confetti.</div>
          </div>
        </div>

        <div class="board" id="board">
          <canvas class="boardBg" id="boardBg"></canvas>

          <!-- big center dice -->
          <div id="centerDice" class="face1" aria-hidden="true">
            <span class="pip p1"></span><span class="pip p2"></span><span class="pip p3"></span>
            <span class="pip p4"></span><span class="pip p5"></span><span class="pip p6"></span>
            <span class="pip p7"></span><span class="pip p8"></span><span class="pip p9"></span>
          </div>

          <div class="track" id="track"></div>
          <div class="fxLayer" id="fxLayer"></div>
        </div>

        <div class="note" style="text-align:center">
          Questions answered: <b id="qDone">0</b>/<b id="qTotal">0</b> ‚Ä¢ Correct: <b id="qCorrect">0</b>
        </div>

      </div>
    </div>
  </div>

</div>

<div class="bigPop" id="bigPop"></div>

<div class="overlay" id="overlay" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="mhd">
      <div class="mt" id="modalTitle">How to Play</div>
      <button id="btnClose">Close</button>
    </div>
    <div class="mbd" id="modalBody"></div>
  </div>
</div>

<script>
(() => {
  /* =========================
     SETTINGS
  ========================= */
  const COMPUTER_STEP_ON_WRONG = 2;
  const RETURN_TO_MCQ_DELAY_MS = 1800;

  // Spark on landing (keep simple and consistent)
  const SAFE_INDICES = new Set([3, 7, 11, 15, 19]);

  /* =========================
     TRACK (7x7 overlay path)
  ========================= */
  const TRACK_GRID_INDEX = [
    2,3,4,5,6,
    13,20,27,34,41,
    46,45,44,43,42,
    35,28,21,14,7,
    8,9,10,11
  ];
  const FINISH_INDEX = TRACK_GRID_INDEX.length - 1;

  /* =========================
     HARDWIRED MCQs (same set)
     Note:
     - a is 0..3 index
  ========================= */
  let QUESTIONS = [
    { id:"SMS_LUDO_Q01", q:"Why is using https:// recommended when logging into social networking sites?",
      opts:["It encrypts traffic between your browser and the site","It blocks all ads automatically","It prevents account creation","It makes your posts invisible to the platform"],
      a:0,
      fb:"HTTPS encrypts data in transit (like passwords and messages), reducing interception risk."
    },
    { id:"SMS_LUDO_Q02", q:"During Facebook setup, what is the safer choice on the ‚ÄúFind Your Friends‚Äù step?",
      opts:["Enter your email password so Facebook can import contacts","Skip providing your email password to Facebook","Share your phone contacts publicly","Turn on public search immediately"],
      a:1,
      fb:"Avoid sharing your email password for contact importing."
    },
    { id:"SMS_LUDO_Q03", q:"Which Facebook feature can alert you if someone logs in from an unfamiliar device?",
      opts:["Public Search","Privacy Shortcuts","Login Notifications","Friend Suggestions"],
      a:2,
      fb:"Login Notifications can warn you about logins from devices you have not used before."
    },
    { id:"SMS_LUDO_Q04", q:"To reduce exposure in Facebook advertising settings, a recommended choice for ‚ÄúThird Party Sites‚Äù is:",
      opts:["Everyone","Friends","Only Me","No-one"],
      a:3,
      fb:"Setting it to ‚ÄúNo-one‚Äù reduces third-party advertising association."
    },
    { id:"SMS_LUDO_Q05", q:"If you want your Facebook status updates visible only to your contacts, choose:",
      opts:["Friends Only (or a restricted audience you choose)","Public (everyone)","Friends of friends","Anyone via search engines"],
      a:0,
      fb:"Use a restricted audience like ‚ÄúFriends Only‚Äù for routine posts."
    },
    { id:"SMS_LUDO_Q06", q:"What is a safer practice before posting a photo/video of another person?",
      opts:["Post first and ask later","Get their consent first","Always tag them publicly","Share it only in comments"],
      a:1,
      fb:"Consent matters because posts can be copied, reshared, and misunderstood later."
    },
    { id:"SMS_LUDO_Q07", q:"Which Twitter setting limits tweets so only approved followers can see them?",
      opts:["Discoverability","Tweet location","Protect your Tweets","Personalization"],
      a:2,
      fb:"Protecting tweets makes your content visible only to approved followers."
    },
    { id:"SMS_LUDO_Q08", q:"A key risk of linking/auto-posting between multiple social networks is:",
      opts:["It guarantees anonymity everywhere","It always improves privacy","It prevents metadata leaks","You may be anonymous on one site but exposed on another"],
      a:3,
      fb:"Cross-posting can connect identities across platforms."
    },
    { id:"SMS_LUDO_Q09", q:"Why should you be cautious while sharing photos/videos online (even with privacy settings)?",
      opts:["They can reveal identities and sensitive details like location/time","They always delete automatically","They cannot be copied by others","They are invisible to service providers"],
      a:0,
      fb:"Images/videos can leak personal information and may be downloaded or reshared."
    },
    { id:"SMS_LUDO_Q10", q:"What is a safer approach to location sharing on social media?",
      opts:["Enable location on every post","Keep location off unless needed and double-check settings","Share live location publicly during travel","Assume location cannot be inferred without GPS"],
      a:1,
      fb:"Location can reveal routines and real-time presence. Keep it off unless necessary."
    },
    { id:"SMS_LUDO_Q11", q:"If your browser warns about an invalid security certificate while using webmail, it may indicate:",
      opts:["Your inbox is full","Your password is too strong","Possible interception/tampering of the connection","Your account is permanently deleted"],
      a:2,
      fb:"Certificate warnings can signal a man-in-the-middle risk or misconfigured security."
    },
    { id:"SMS_LUDO_Q12", q:"The chapter compares social networking sites to a ‚Äúhuge party‚Äù mainly to suggest that:",
      opts:["Only friends can see your content","Privacy settings fully prevent exposure","Everyone at the party is trustworthy","You may reveal personal details widely without realizing it"],
      a:3,
      fb:"The metaphor highlights unintended oversharing and broad visibility."
    },
    { id:"SMS_LUDO_Q13", q:"Which email practice reduces malware risk?",
      opts:["Avoid unexpected attachments, especially from unknown senders","Open all attachments quickly to check content","Disable antivirus warnings","Forward suspicious attachments to others"],
      a:0,
      fb:"Unexpected attachments are a common malware route; verify before opening."
    },
    { id:"SMS_LUDO_Q14", q:"To avoid revealing identity when creating an email account, the guide suggests using:",
      opts:["Your full legal name as username","Anonymity software such as Tor","The same username everywhere","Only your official work email"],
      a:1,
      fb:"Tor can help hide network identity; also avoid usernames linked to your real identity."
    },
    { id:"SMS_LUDO_Q15", q:"A common sign of an email scam is:",
      opts:["A friendly message that matches an ongoing conversation","A newsletter you subscribed to from a trusted source","An urgent warning asking you to click a link and ‚Äúverify‚Äù or ‚Äúupdate‚Äù your account","A normal reply that contains no links or requests"],
      a:2,
      fb:"Scams often create urgency and push you to click links or submit credentials."
    },
    { id:"SMS_LUDO_Q16", q:"A safer response if you receive an unexpected password-reset email is:",
      opts:["Click the link immediately","Reply with your details to confirm","Ignore and continue using the same password","Visit the service by typing the official URL yourself and check account activity"],
      a:3,
      fb:"Avoid clicking links in suspicious emails; go directly to the official site/app."
    },
    { id:"SMS_LUDO_Q17", q:"Why is it risky to use the same password across social platforms?",
      opts:["One breach can lead to multiple account takeovers (credential reuse)","It prevents password recovery","It forces public posting","It stops you from using HTTPS"],
      a:0,
      fb:"If one site is compromised, attackers try the same password elsewhere."
    },
    { id:"SMS_LUDO_Q18", q:"What is a safer setting for photo tagging if you want to reduce risk?",
      opts:["Allow everyone to tag you","Do not allow photo tagging / restrict it as much as possible","Enable tagging suggestions","Auto-approve all tags"],
      a:1,
      fb:"Tagging can expose you and your connections. Restrict or disable if possible."
    },
    { id:"SMS_LUDO_Q19", q:"When installing third-party apps connected to your social accounts, the best first step is to:",
      opts:["Install quickly and decide later","Grant all permissions to avoid errors","Review permissions and avoid apps requesting unnecessary access","Share the app link with everyone"],
      a:2,
      fb:"App permissions can expose data. Avoid apps requesting more access than needed."
    },
    { id:"SMS_LUDO_Q20", q:"A safe practice to limit oversharing on social media is:",
      opts:["Always keep profiles public","Post travel plans in real time publicly","Share personal identifiers (DOB, address) to build trust","Use privacy settings + think before posting sensitive details"],
      a:3,
      fb:"Privacy settings help, but judgment before posting is equally important."
    }
  ];

  /* =========================
     STATE
  ========================= */
  let order = [];
  let qi = 0;
  let answered = 0;
  let correct = 0;
  let p1 = 0;
  let p2 = 0;
  let locked = false;
  let gameOver = false;
  let pending = null;

  /* =========================
     ELEMENTS
  ========================= */
  const app = document.getElementById("app");
  const mcqScreen = document.getElementById("mcqScreen");
  const boardScreen = document.getElementById("boardScreen");

  const trackEl = document.getElementById("track");
  const fxLayer = document.getElementById("fxLayer");

  const qTextEl = document.getElementById("qText");
  const optsEl = document.getElementById("opts");

  const p1PosEl = document.getElementById("p1Pos");
  const p2PosEl = document.getElementById("p2Pos");
  const maxPosEl = document.getElementById("maxPos");
  const maxPos2El = document.getElementById("maxPos2");
  const qDoneEl = document.getElementById("qDone");
  const qTotalEl = document.getElementById("qTotal");
  const qCorrectEl = document.getElementById("qCorrect");
  const diceEl = document.getElementById("dice");
  const statusTextEl = document.getElementById("statusText");
  const animHintEl = document.getElementById("animHint");

  const overlay = document.getElementById("overlay");
  const modalTitle = document.getElementById("modalTitle");
  const modalBody = document.getElementById("modalBody");
  const bigPop = document.getElementById("bigPop");

  const confettiCanvas = document.getElementById("confetti");
  const confettiCtx = confettiCanvas.getContext("2d");

  const boardBg = document.getElementById("boardBg");
  const centerDice = document.getElementById("centerDice");

  const btnHow = document.getElementById("btnHow");
  const btnRestart = document.getElementById("btnRestart");
  const btnSkip = document.getElementById("btnSkip");
  const btnClose = document.getElementById("btnClose");

  /* =========================
     EVENTS
  ========================= */
  btnHow.addEventListener("click", showHow);
  btnClose.addEventListener("click", hideModal);
  overlay.addEventListener("click", (e) => { if (e.target === overlay) hideModal(); });

  btnRestart.addEventListener("click", restart);
  btnSkip.addEventListener("click", () => {
    if (locked || gameOver) return;
    popNeutral("Skipped (no movement)");
    advanceQuestion();
  });

  /* =========================
     INIT
  ========================= */
  maxPosEl.textContent = String(TRACK_GRID_INDEX.length - 1);
  maxPos2El.textContent = String(TRACK_GRID_INDEX.length - 1);

  buildBoard();
  drawLudoBackground();
  window.addEventListener("resize", drawLudoBackground);

  restart();

  /* =========================
     SCREEN CONTROL
  ========================= */
  function showScreen(which){
    if (which === "mcq"){
      mcqScreen.classList.add("active");
      boardScreen.classList.remove("active");
    } else {
      boardScreen.classList.add("active");
      mcqScreen.classList.remove("active");
      requestAnimationFrame(drawLudoBackground);
    }
  }

  /* =========================
     BOARD (7x7 overlay)
  ========================= */
  function buildBoard(){
    trackEl.innerHTML = "";
    for(let i=0;i<49;i++){
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.dataset.grid = String(i);

      const tpos = TRACK_GRID_INDEX.indexOf(i);
      if (tpos !== -1){
        cell.dataset.track = String(tpos);

        if (tpos === 0) cell.classList.add("start");
        if (tpos === TRACK_GRID_INDEX.length - 1) cell.classList.add("finish");
        if (SAFE_INDICES.has(tpos)) cell.classList.add("safe");

        const badge = document.createElement("div");
        badge.className = "badge";
        badge.textContent = (tpos === 0) ? "START" : (tpos === TRACK_GRID_INDEX.length - 1) ? "HOME" : `#${tpos}`;
        cell.appendChild(badge);

        const tokens = document.createElement("div");
        tokens.className = "tokens";
        tokens.innerHTML = `
          <div class="token t1" style="display:none" aria-label="Learner token"></div>
          <div class="token t2" style="display:none" aria-label="Computer token"></div>
        `;
        cell.appendChild(tokens);
      }
      trackEl.appendChild(cell);
    }
  }

  function getTrackCell(pos){
    const gridIndex = TRACK_GRID_INDEX[pos];
    return document.querySelector(\`.cell[data-grid="\${gridIndex}"]\`);
  }

  /* =========================
     LUDO BACKGROUND (canvas)
  ========================= */
  function drawLudoBackground(){
    const rect = boardBg.getBoundingClientRect();
    const dpr = Math.max(1, window.devicePixelRatio || 1);

    boardBg.width = Math.floor(rect.width * dpr);
    boardBg.height = Math.floor(rect.height * dpr);

    const ctx = boardBg.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0);

    const W = rect.width;
    const H = rect.height;
    ctx.clearRect(0,0,W,H);

    const pad = 12;
    const x0 = pad, y0 = pad, w = W - pad*2, h = H - pad*2;
    const r = 22;

    // base plate
    roundRect(ctx, x0, y0, w, h, r);
    ctx.fillStyle = "rgba(255,255,255,1)";
    ctx.fill();

    // corners
    const halfW = w/2;
    const halfH = h/2;

    fillCorner(ctx, x0, y0, halfW, halfH, "rgba(22,163,74,0.98)");
    fillCorner(ctx, x0+halfW, y0, halfW, halfH, "rgba(250,204,21,0.98)");
    fillCorner(ctx, x0, y0+halfH, halfW, halfH, "rgba(239,68,68,0.98)");
    fillCorner(ctx, x0+halfW, y0+halfH, halfW, halfH, "rgba(37,99,235,0.98)");

    // white cross
    const crossW = w * 0.18;
    ctx.fillStyle = "rgba(255,255,255,1)";
    ctx.fillRect(x0 + halfW - crossW/2, y0, crossW, h);
    ctx.fillRect(x0, y0 + halfH - crossW/2, w, crossW);

    // colored lanes inside cross
    const lane = w * 0.06;
    ctx.fillStyle = "rgba(22,163,74,0.98)";
    ctx.fillRect(x0 + halfW - lane/2, y0, lane, halfH);
    ctx.fillStyle = "rgba(250,204,21,0.98)";
    ctx.fillRect(x0 + halfW, y0, lane, halfH);
    ctx.fillStyle = "rgba(239,68,68,0.98)";
    ctx.fillRect(x0 + halfW - lane/2, y0 + halfH, lane, halfH);
    ctx.fillStyle = "rgba(37,99,235,0.98)";
    ctx.fillRect(x0 + halfW, y0 + halfH, lane, halfH);

    // printed grid lines
    ctx.save();
    ctx.globalAlpha = 0.14;
    ctx.strokeStyle = "#000";
    ctx.lineWidth = 1;
    for(let i=1;i<12;i++){
      const gx = x0 + (w/12)*i;
      const gy = y0 + (h/12)*i;
      ctx.beginPath(); ctx.moveTo(gx,y0); ctx.lineTo(gx,y0+h); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(x0,gy); ctx.lineTo(x0+w,gy); ctx.stroke();
    }
    ctx.restore();

    // center diamond
    const cx = x0 + halfW;
    const cy = y0 + halfH;
    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(Math.PI/4);
    ctx.fillStyle = "rgba(255,255,255,1)";
    ctx.strokeStyle = "rgba(0,0,0,0.22)";
    ctx.lineWidth = 2;
    const d = w * 0.13;
    ctx.beginPath();
    ctx.rect(-d, -d, d*2, d*2);
    ctx.fill();
    ctx.stroke();
    ctx.restore();

    // home circles + 4 dots
    drawHomeCircle(ctx, x0 + halfW*0.5, y0 + halfH*0.5, w*0.12, "rgba(255,255,255,0.92)");
    drawHomeCircle(ctx, x0 + halfW*1.5, y0 + halfH*0.5, w*0.12, "rgba(255,255,255,0.92)");
    drawHomeCircle(ctx, x0 + halfW*0.5, y0 + halfH*1.5, w*0.12, "rgba(255,255,255,0.92)");
    drawHomeCircle(ctx, x0 + halfW*1.5, y0 + halfH*1.5, w*0.12, "rgba(255,255,255,0.92)");

    dot4(ctx, x0 + halfW*0.5, y0 + halfH*0.5, w*0.12, "rgba(22,163,74,0.98)");
    dot4(ctx, x0 + halfW*1.5, y0 + halfH*0.5, w*0.12, "rgba(250,204,21,0.98)");
    dot4(ctx, x0 + halfW*0.5, y0 + halfH*1.5, w*0.12, "rgba(239,68,68,0.98)");
    dot4(ctx, x0 + halfW*1.5, y0 + halfH*1.5, w*0.12, "rgba(37,99,235,0.98)");

    // border line
    ctx.save();
    ctx.strokeStyle = "rgba(0,0,0,0.20)";
    ctx.lineWidth = 2;
    roundRect(ctx, x0, y0, w, h, r);
    ctx.stroke();
    ctx.restore();
  }

  function roundRect(ctx, x, y, w, h, r){
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.arcTo(x+w, y, x+w, y+h, r);
    ctx.arcTo(x+w, y+h, x, y+h, r);
    ctx.arcTo(x, y+h, x, y, r);
    ctx.arcTo(x, y, x+w, y, r);
    ctx.closePath();
  }

  function fillCorner(ctx, x, y, w, h, color){
    ctx.save();
    ctx.fillStyle = color;
    ctx.fillRect(x, y, w, h);
    const g = ctx.createRadialGradient(x+w*0.25, y+h*0.25, 10, x+w*0.25, y+h*0.25, Math.max(w,h));
    g.addColorStop(0, "rgba(255,255,255,0.18)");
    g.addColorStop(1, "rgba(255,255,255,0)");
    ctx.fillStyle = g;
    ctx.fillRect(x,y,w,h);
    ctx.restore();
  }

  function drawHomeCircle(ctx, cx, cy, r, fill){
    ctx.save();
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, Math.PI*2);
    ctx.fillStyle = fill;
    ctx.fill();
    ctx.strokeStyle = "rgba(0,0,0,0.22)";
    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.restore();
  }

  function dot4(ctx, cx, cy, r, color){
    const rr = r*0.18;
    const offs = r*0.38;
    ctx.save();
    ctx.fillStyle = color;
    [[-offs,-offs],[offs,-offs],[-offs,offs],[offs,offs]].forEach(([dx,dy])=>{
      ctx.beginPath();
      ctx.arc(cx+dx, cy+dy, rr, 0, Math.PI*2);
      ctx.fill();
      ctx.strokeStyle = "rgba(0,0,0,0.18)";
      ctx.lineWidth = 1;
      ctx.stroke();
    });
    ctx.restore();
  }

  /* =========================
     GAME FLOW
  ========================= */
  function restart(){
    order = Array.from({length: QUESTIONS.length}, (_,i)=>i);

    // Keep control-group order (Q01..Q20) strictly:
    // Do NOT shuffle.

    qi = 0;
    answered = 0;
    correct = 0;
    p1 = 0; p2 = 0;
    locked = false;
    gameOver = false;
    pending = null;

    diceEl.textContent = "‚Äî";
    diceEl.classList.remove("rolling");

    centerDice.className = "face1";
    centerDice.classList.remove("show","rolling");

    clearGlows();
    clearFx();

    maxPosEl.textContent = String(FINISH_INDEX);
    maxPos2El.textContent = String(FINISH_INDEX);

    qTotalEl.textContent = String(QUESTIONS.length);

    updateStats();
    renderTokens();

    statusTextEl.textContent = "Waiting‚Ä¶";
    animHintEl.textContent = "Waiting‚Ä¶";

    showScreen("mcq");
    renderQuestion();
  }

  function clearGlows(){
    document.querySelectorAll(".cell").forEach(c => c.classList.remove("glowP1","glowP2"));
  }
  function clearFx(){ fxLayer.innerHTML = ""; }

  function renderTokens(){
    document.querySelectorAll(".cell[data-track] .token").forEach(t => t.style.display="none");
    const c1 = getTrackCell(p1);
    const c2 = getTrackCell(p2);
    if (c1) c1.querySelector(".t1").style.display = "inline-block";
    if (c2) c2.querySelector(".t2").style.display = "inline-block";
  }

  function updateStats(){
    p1PosEl.textContent = String(p1);
    p2PosEl.textContent = String(p2);
    qDoneEl.textContent = String(answered);
    qCorrectEl.textContent = String(correct);
  }

  function renderQuestion(){
    if (qi >= order.length){
      endByQuestions();
      return;
    }
    const Q = QUESTIONS[order[qi]];
    qTextEl.textContent = `Q${answered + 1}. ${Q.q}`;
    optsEl.innerHTML = "";
    const letters = ["A","B","C","D"];
    Q.opts.forEach((txt, i) => {
      const btn = document.createElement("button");
      btn.className = "optBtn";
      btn.innerHTML = `<span class="lab">${letters[i]}</span><span>${escapeHtml(txt)}</span>`;
      btn.addEventListener("click", () => choose(i));
      optsEl.appendChild(btn);
    });
  }

  async function choose(i){
    if (locked || gameOver) return;
    locked = true;

    const Q = QUESTIONS[order[qi]];
    const isCorrect = (i === Q.a);
    answered += 1;

    if (isCorrect){
      correct += 1;
      popOK("Correct!");
      const roll = 1 + Math.floor(Math.random()*6);
      pending = { type:"correct", roll, fb: Q.fb || "" };
      showFeedback(true, Q.fb || "Good.", () => runPendingAnimationAndAdvance());
    } else {
      popBad("Wrong!");
      app.classList.remove("shake"); void app.offsetWidth; app.classList.add("shake");

      const correctLetter = ["A","B","C","D"][Q.a];
      const correctText = Q.opts[Q.a];
      pending = { type:"wrong", steps: COMPUTER_STEP_ON_WRONG, fb: Q.fb || "", corr: {letter: correctLetter, text: correctText} };

      const fbHtml =
        `Correct answer: <b>${correctLetter}</b> ‚Äî ${escapeHtml(correctText)}`
        + (Q.fb ? `<br/><br/>${escapeHtml(Q.fb)}` : "");

      showFeedback(false, fbHtml, () => runPendingAnimationAndAdvance());
    }

    updateStats();
  }

  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  async function runPendingAnimationAndAdvance(){
    hideModal();
    if (!pending) { locked = false; return; }

    showScreen("board");
    clearFx();
    clearGlows();
    renderTokens();
    updateStats();

    if (pending.type === "correct"){
      animHintEl.textContent = "Correct ‚Üí rolling dice‚Ä¶";
      statusTextEl.textContent = "Rolling‚Ä¶";

      // show big center dice + small UI dice rolling
      centerDice.classList.add("show","rolling");
      diceEl.classList.add("rolling");

      let ticks = 0;
      while (ticks < 10){
        const v = 1 + Math.floor(Math.random()*6);
        diceEl.textContent = String(v);
        setCenterDiceFace(v);
        await sleep(60);
        ticks++;
      }

      diceEl.textContent = String(pending.roll);
      setCenterDiceFace(pending.roll);

      await sleep(140);
      diceEl.classList.remove("rolling");
      centerDice.classList.remove("rolling");
      setTimeout(()=> centerDice.classList.remove("show"), 450);

      animHintEl.textContent = `Moving ${pending.roll} step(s)‚Ä¶`;
      statusTextEl.textContent = `You move ${pending.roll} step(s).`;
      await movePlayerAnimated(1, pending.roll);
    } else {
      diceEl.textContent = "‚Äî";
      diceEl.classList.remove("rolling");
      centerDice.classList.remove("rolling");
      centerDice.classList.remove("show");

      animHintEl.textContent = `Wrong ‚Üí computer moves +${pending.steps}`;
      statusTextEl.textContent = `Computer moves ${pending.steps} step(s).`;
      await movePlayerAnimated(2, pending.steps);
    }

    checkEnd();
    if (!gameOver){
      animHintEl.textContent = "Enjoy the board‚Ä¶";
      await sleep(RETURN_TO_MCQ_DELAY_MS);

      advanceQuestion();
      showScreen("mcq");
      locked = false;
    }

    pending = null;
  }

  function setCenterDiceFace(v){
    centerDice.className = `face${v}`;
  }

  async function movePlayerAnimated(which, steps){
    const isLearner = (which === 1);
    const glowClass = isLearner ? "glowP1" : "glowP2";
    const trailColor = isLearner ? "rgba(52,211,153,.90)" : "rgba(251,113,133,.90)";

    for(let s=0; s<steps; s++){
      if (isLearner) p1 = Math.min(FINISH_INDEX, p1 + 1);
      else p2 = Math.min(FINISH_INDEX, p2 + 1);

      clearGlows();
      const posNow = isLearner ? p1 : p2;
      const cell = getTrackCell(posNow);
      if (cell) cell.classList.add(glowClass);

      renderTokens();
      updateStats();

      if (cell){
        const {x,y} = cellCenterInFxLayer(cell);
        spawnTrail(x, y, trailColor);

        if (SAFE_INDICES.has(posNow)) spawnSpark(x, y);
      }

      const token = cell ? cell.querySelector(isLearner ? ".t1" : ".t2") : null;
      if (token){
        token.classList.remove("hop");
        void token.offsetWidth;
        token.classList.add("hop");
      }

      await sleep(170);
      if ((isLearner && p1 >= FINISH_INDEX) || (!isLearner && p2 >= FINISH_INDEX)) break;
    }
    clearGlows();
  }

  function advanceQuestion(){ qi += 1; renderQuestion(); }

  function checkEnd(){
    if (p1 >= FINISH_INDEX){
      gameOver = true;
      fireConfettiLight(1200);
      showModal(
        "You reached Home üéâ",
        `
          <div class="note">You reached HOME first.</div>
          <div class="kbd">
            <div><b>Your score:</b> ${correct} / ${QUESTIONS.length}</div>
            <div><b>Model B:</b> Computer moves only when you are wrong.</div>
          </div>
        `
      );
      locked = true;
      return;
    }

    if (p2 >= FINISH_INDEX){
      gameOver = true;
      showModal(
        "System reached Home",
        `
          <div class="note">Computer reached HOME first.</div>
          <div class="kbd">
            <div><b>Your score:</b> ${correct} / ${QUESTIONS.length}</div>
            <div>Restart and focus on accuracy to stay ahead.</div>
          </div>
        `
      );
      locked = true;
    }
  }

  function endByQuestions(){
    gameOver = true;
    const acc = QUESTIONS.length ? Math.round((correct/QUESTIONS.length)*100) : 0;
    const pass = acc >= 60;

    showModal(
      "Quiz Finished",
      `
        <div class="note">You completed all questions. Accuracy is the main score.</div>
        <div class="kbd">
          <div><b>Correct:</b> ${correct} / ${QUESTIONS.length} (${acc}%)</div>
          <div><b>Status:</b> ${pass ? `<span style="color:rgba(34,197,94,.95);font-weight:900;">Good mastery</span>` :
                                   `<span style="color:rgba(245,158,11,.95);font-weight:900;">Needs revision</span>`}
          </div>
          <div>You can restart to practice again.</div>
        </div>
      `
    );
    locked = true;
  }

  /* =========================
     MODAL / UI
  ========================= */
  function showHow(){
    showModal(
      "How to Play (Model B)",
      `
        <div class="note">
          One screen at a time: <b>MCQ</b> ‚Üí <b>Board animation</b> ‚Üí next <b>MCQ</b>.
        </div>
        <div class="kbd">
          <div><b>Correct:</b> Dice rolls and learner token moves step-by-step.</div>
          <div><b>Wrong:</b> Learner does not move, computer moves <b>+${COMPUTER_STEP_ON_WRONG}</b>.</div>
          <div><b>Effects:</b> Trail on movement, spark on safe squares, confetti on HOME.</div>
          <div><b>Goal:</b> Reach <b>HOME</b> before the computer by keeping accuracy high.</div>
          <div><b>Order:</b> Questions are in the fixed control-group sequence (Q01‚ÄìQ20).</div>
        </div>
      `
    );
  }

  function showFeedback(isCorrect, html, onContinue){
    const title = isCorrect ? "Correct ‚úÖ" : "Wrong ‚ùå";
    const body = `
      <div class="note">${html}</div>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">
        <button class="primary" id="continueBtn">${gameOver ? "Close" : "Continue"}</button>
      </div>
    `;
    showModal(title, body);
    setTimeout(() => {
      const btn = document.getElementById("continueBtn");
      if (btn){
        btn.addEventListener("click", async () => {
          if (typeof onContinue === "function") await onContinue();
        });
      }
    }, 0);
  }

  function showModal(title, html){
    modalTitle.textContent = title;
    modalBody.innerHTML = html;
    overlay.style.display = "flex";
  }
  function hideModal(){ overlay.style.display = "none"; }

  function popOK(txt){ showPop(txt, "ok"); }
  function popBad(txt){ showPop(txt, "bad"); }
  function popNeutral(txt){
    bigPop.className = "bigPop";
    bigPop.textContent = txt;
    bigPop.style.display = "block";
    setTimeout(() => bigPop.style.display="none", 850);
  }
  function showPop(txt, cls){
    bigPop.className = `bigPop ${cls}`;
    bigPop.textContent = txt;
    bigPop.style.display = "block";
    setTimeout(() => bigPop.style.display="none", 650);
  }

  /* =========================
     FX: trail + spark
  ========================= */
  function cellCenterInFxLayer(cellEl){
    const fxRect = fxLayer.getBoundingClientRect();
    const cellRect = cellEl.getBoundingClientRect();
    const cx = (cellRect.left + cellRect.width/2) - fxRect.left;
    const cy = (cellRect.top + cellRect.height/2) - fxRect.top;
    return { x: cx, y: cy };
  }

  function spawnTrail(x, y, color){
    const dot = document.createElement("div");
    dot.className = "trailDot";
    dot.style.left = `${x}px`;
    dot.style.top = `${y}px`;
    dot.style.background = `radial-gradient(circle at 35% 35%, rgba(255,255,255,.35), ${color} 60%, rgba(0,0,0,0) 72%)`;
    fxLayer.appendChild(dot);
    setTimeout(() => dot.remove(), 480);
  }

  function spawnSpark(x, y){
    const wrap = document.createElement("div");
    wrap.className = "sparkWrap";
    wrap.style.left = `${x}px`;
    wrap.style.top = `${y}px`;
    fxLayer.appendChild(wrap);

    const count = 10;
    for(let i=0;i<count;i++){
      const s = document.createElement("div");
      s.className = "spark";
      const ang = Math.random() * Math.PI * 2;
      const dist = 18 + Math.random()*18;
      const dx = Math.cos(ang) * dist;
      const dy = Math.sin(ang) * dist;
      s.style.setProperty("--dx", `${dx}px`);
      s.style.setProperty("--dy", `${dy}px`);
      const hue = 38 + Math.floor(Math.random()*25);
      s.style.background = `hsl(${hue} 95% 62%)`;
      wrap.appendChild(s);
      setTimeout(() => s.remove(), 520);
    }
    setTimeout(() => wrap.remove(), 560);
  }

  /* =========================
     CONFETTI
  ========================= */
  function resizeConfettiCanvas(){
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    confettiCanvas.width = Math.floor(window.innerWidth * dpr);
    confettiCanvas.height = Math.floor(window.innerHeight * dpr);
    confettiCanvas.style.width = "100vw";
    confettiCanvas.style.height = "100vh";
    confettiCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  window.addEventListener("resize", () => {
    if (confettiCanvas.style.display === "block") resizeConfettiCanvas();
  });

  function fireConfettiLight(durationMs = 1200){
    resizeConfettiCanvas();
    confettiCanvas.style.display = "block";

    const W = window.innerWidth;
    const H = window.innerHeight;

    const colors = [
      "hsl(150 75% 55%)",
      "hsl(205 85% 60%)",
      "hsl(330 85% 65%)",
      "hsl(45 95% 60%)"
    ];

    const parts = [];
    const N = 90;
    for(let i=0;i<N;i++){
      parts.push({
        x: Math.random() * W,
        y: -20 - Math.random()*H*0.2,
        vx: -1.2 + Math.random()*2.4,
        vy: 2.0 + Math.random()*3.4,
        size: 4 + Math.random()*5,
        rot: Math.random()*Math.PI*2,
        vr: -0.12 + Math.random()*0.24,
        c: colors[Math.floor(Math.random()*colors.length)]
      });
    }

    let start = performance.now();
    function tick(now){
      const t = now - start;
      confettiCtx.clearRect(0,0,W,H);
      confettiCtx.globalAlpha = 0.95;

      for(const p of parts){
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.02;
        p.rot += p.vr;

        confettiCtx.save();
        confettiCtx.translate(p.x, p.y);
        confettiCtx.rotate(p.rot);
        confettiCtx.fillStyle = p.c;
        confettiCtx.fillRect(-p.size/2, -p.size/3, p.size, p.size*0.66);
        confettiCtx.restore();
      }

      if (t < durationMs){
        requestAnimationFrame(tick);
      } else {
        confettiCtx.clearRect(0,0,W,H);
        confettiCanvas.style.display = "none";
      }
    }
    requestAnimationFrame(tick);
  }

  /* =========================
     HELPERS
  ========================= */
  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
})();
</script>
</body>
</html>
