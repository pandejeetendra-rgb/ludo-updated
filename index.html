<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cyber Ludo Quiz (Model B) — Hardwired MCQs</title>

<style>
  :root{
    --bg1:#0b1020; --bg2:#0b2a55;
    --stroke: rgba(255,255,255,.18);
    --text:#f7fbff; --muted: rgba(247,251,255,.75);
    --p1:#34d399; --p2:#fb7185;
    --shadow: 0 12px 35px rgba(0,0,0,.35);
    --radius: 18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--text);
    min-height:100vh;
    background:
      radial-gradient(1200px 700px at 15% 10%, rgba(96,165,250,.35), transparent 60%),
      radial-gradient(900px 700px at 85% 20%, rgba(52,211,153,.25), transparent 55%),
      radial-gradient(900px 700px at 80% 90%, rgba(251,113,133,.22), transparent 60%),
      linear-gradient(160deg, var(--bg1), var(--bg2));
  }
  .wrap{
    max-width: 1200px;
    margin: 0 auto;
    padding: 14px;
    display:grid;
    grid-template-columns: 1fr;
    gap: 14px;
  }
  .topbar{
    display:flex; align-items:center; justify-content:space-between;
    gap:12px;
    padding: 12px 14px;
    border:1px solid var(--stroke);
    border-radius: var(--radius);
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
    box-shadow: var(--shadow);
  }
  .brand{ display:flex; align-items:center; gap:10px; min-width: 0; }
  .logo{
    width:38px; height:38px; border-radius:12px;
    background:
      radial-gradient(circle at 30% 35%, rgba(255,255,255,.55), transparent 45%),
      linear-gradient(135deg, rgba(96,165,250,.9), rgba(52,211,153,.9));
    box-shadow: 0 10px 20px rgba(0,0,0,.25);
    flex: 0 0 auto;
  }
  .brand h1{
    font-size: 15px; margin:0; line-height:1.2; letter-spacing:.2px;
    white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
  }
  .brand p{ margin:2px 0 0; font-size: 12px; color: var(--muted); }
  .actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
  button{
    border: 1px solid var(--stroke);
    background: rgba(255,255,255,.10);
    color: var(--text);
    padding: 10px 12px;
    border-radius: 14px;
    cursor:pointer;
    transition: transform .08s ease, background .15s ease, border-color .15s ease;
    font-weight: 800;
    letter-spacing:.15px;
  }
  button:hover{ background: rgba(255,255,255,.14); }
  button:active{ transform: scale(.98); }
  button.primary{
    border-color: rgba(96,165,250,.55);
    background: linear-gradient(180deg, rgba(96,165,250,.30), rgba(96,165,250,.18));
  }
  button.good{
    border-color: rgba(34,197,94,.55);
    background: linear-gradient(180deg, rgba(34,197,94,.25), rgba(34,197,94,.12));
  }
  button.danger{
    border-color: rgba(239,68,68,.55);
    background: linear-gradient(180deg, rgba(239,68,68,.22), rgba(239,68,68,.10));
  }
  button:disabled{ opacity:.55; cursor:not-allowed; }

  .card{
    border:1px solid var(--stroke);
    border-radius: var(--radius);
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .card .hd{
    padding: 12px 14px;
    border-bottom: 1px solid rgba(255,255,255,.10);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .card .hd .ttl{ font-weight: 950; letter-spacing:.2px; }
  .card .hd .sub{ font-size:12px; color:var(--muted); }
  .card .bd{ padding: 14px; }

  .screen{ display:none; }
  .screen.active{ display:block; }

  /* Error box */
  .errBox{
    display:none;
    margin: 12px 0 0;
    padding: 12px 12px;
    border-radius: 16px;
    border: 1px solid rgba(239,68,68,.45);
    background: rgba(239,68,68,.12);
    color: rgba(255,255,255,.95);
    font-size: 13px;
    line-height: 1.45;
    white-space: pre-wrap;
  }

  /* Quiz */
  .qText{
    font-size: 16px; font-weight: 950;
    line-height: 1.35; margin: 0 0 12px;
  }
  .optGrid{ display:grid; grid-template-columns: 1fr; gap: 10px; }
  .optBtn{
    text-align:left;
    font-weight: 850;
    padding: 12px 12px;
    border-radius: 16px;
    background: rgba(255,255,255,.08);
  }
  .optBtn .lab{
    display:inline-flex;
    width: 30px; height: 30px;
    align-items:center; justify-content:center;
    border-radius: 12px;
    margin-right: 10px;
    font-weight: 950;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.18);
  }
  .optBtn:hover{ background: rgba(255,255,255,.12); }
  .note{ font-size: 12px; color: var(--muted); line-height: 1.5; }

  /* Board */
  .boardWrap{ display:flex; flex-direction: column; gap: 12px; }
  .boardTopInfo{
    display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
    flex-wrap:wrap;
  }
  .pill{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.07);
    border-radius: 16px;
    padding: 10px 12px;
  }
  .pill .k{ font-size:12px; color: var(--muted); }
  .pill .v{ font-size: 15px; font-weight: 950; margin-top: 2px; }

  .board{
    width: min(580px, 100%);
    aspect-ratio: 1 / 1;
    margin: 0 auto;
    border-radius: 28px;
    position: relative;
    overflow:hidden;
    background: linear-gradient(180deg, rgba(255,220,140,.95), rgba(255,165,40,.92));
    box-shadow: 0 18px 45px rgba(0,0,0,.40);
    padding: 10px;
  }
  .board::before{
    content:"";
    position:absolute;
    inset:10px;
    border-radius: 22px;
    background: rgba(255,255,255,.98);
    box-shadow:
      inset 0 10px 18px rgba(255,255,255,.55),
      inset 0 -10px 18px rgba(0,0,0,.12);
    z-index: 0;
  }

  .boardBg{
    position:absolute;
    inset:10px;
    width:calc(100% - 20px);
    height:calc(100% - 20px);
    z-index: 1;
  }

  .track{
    position:absolute;
    inset:28px;
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    grid-template-rows: repeat(7, 1fr);
    gap: 6px;
    z-index: 2;
  }

  .cell{
    border-radius: 14px;
    border: 1px solid rgba(0,0,0,.14);
    background:
      radial-gradient(circle at 30% 25%, rgba(255,255,255,.98), rgba(245,245,245,.92));
    position: relative;
    overflow:hidden;
    box-shadow: 0 3px 8px rgba(0,0,0,.12);
  }

  .badge{
    position:absolute; top:7px; left:7px;
    font-size: 11px;
    color: rgba(0,0,0,.65);
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid rgba(0,0,0,.15);
    background: rgba(255,255,255,.82);
    z-index: 2;
  }

  .cell.start{
    border-color: rgba(37,99,235,.35);
    background:
      radial-gradient(circle at 30% 25%, rgba(96,165,250,.55), rgba(255,255,255,.92));
  }
  .cell.finish{
    border-color: rgba(22,163,74,.35);
    background:
      radial-gradient(circle at 30% 25%, rgba(34,197,94,.45), rgba(255,255,255,.92));
  }

  .cell.safe{ border-color: rgba(245,158,11,.55); }
  .cell.safe::after{
    content:"★";
    position:absolute;
    right:8px; top:6px;
    font-size: 14px;
    color: rgba(245,158,11,.95);
    text-shadow: 0 2px 4px rgba(0,0,0,.25);
    z-index: 2;
  }

  .tokens{
    position:absolute; right:8px; bottom:8px;
    display:flex; gap:6px;
    z-index: 3;
  }

  .token{
    width: 22px; height: 22px;
    border-radius: 9px;
    border: 2px solid rgba(255,255,255,.95);
    box-shadow: 0 10px 20px rgba(0,0,0,.35);
    position: relative;
  }
  .token::after{
    content:"";
    position:absolute; inset:3px;
    border-radius: 7px;
    background: rgba(255,255,255,.18);
    mix-blend-mode: screen;
  }
  .t1{ background: linear-gradient(135deg, rgba(52,211,153,.95), rgba(16,185,129,.85)); }
  .t2{ background: linear-gradient(135deg, rgba(251,113,133,.95), rgba(244,63,94,.85)); }

  .hop{ animation: hop .18s ease-out 1; }
  @keyframes hop{
    0%{ transform: translateY(0) scale(1); }
    50%{ transform: translateY(-6px) scale(1.06); }
    100%{ transform: translateY(0) scale(1); }
  }

  .fxLayer{
    position:absolute;
    inset:28px;
    pointer-events:none;
    z-index: 5;
  }

  .trailDot{
    position:absolute;
    width: 14px; height: 14px;
    border-radius: 999px;
    transform: translate(-50%, -50%);
    opacity:.95;
    animation: trailFade .42s ease-out forwards;
  }
  @keyframes trailFade{
    0%{ opacity:.85; transform: translate(-50%, -50%) scale(1); }
    100%{ opacity:0; transform: translate(-50%, -50%) scale(.35); }
  }

  .sparkWrap{
    position:absolute;
    width: 1px; height: 1px;
    transform: translate(-50%, -50%);
  }
  .spark{
    position:absolute;
    width: 6px; height: 6px;
    border-radius: 999px;
    opacity: .95;
    animation: sparkFly .50s ease-out forwards;
  }
  @keyframes sparkFly{
    0%{ transform: translate(0,0) scale(1); opacity:.95; }
    100%{ transform: translate(var(--dx), var(--dy)) scale(.45); opacity:0; }
  }

  .dice{
    width: 58px; height: 58px;
    border-radius: 16px;
    border: 1px solid rgba(0,0,0,.15);
    background:
      radial-gradient(circle at 30% 25%, rgba(255,255,255,.95), rgba(235,235,235,.90));
    box-shadow: 0 14px 26px rgba(0,0,0,.35);
    display:flex; align-items:center; justify-content:center;
    font-size: 22px; font-weight: 950;
    user-select:none;
    position: relative;
  }
  .dice.rolling{ animation: diceRoll .35s linear infinite; }
  @keyframes diceRoll{
    0%{ transform: rotate(0deg) scale(1); }
    50%{ transform: rotate(180deg) scale(1.05); }
    100%{ transform: rotate(360deg) scale(1); }
  }

  .overlay{
    position: fixed; inset: 0;
    background: rgba(0,0,0,.55);
    display:none;
    align-items:center; justify-content:center;
    padding: 18px;
    z-index: 999;
  }
  .modal{
    width: min(680px, 100%);
    border-radius: 22px;
    border: 1px solid rgba(255,255,255,.18);
    background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.08));
    box-shadow: 0 18px 50px rgba(0,0,0,.45);
    overflow:hidden;
  }
  .modal .mhd{
    padding: 14px 16px;
    border-bottom: 1px solid rgba(255,255,255,.10);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .modal .mhd .mt{ font-weight: 950; }
  .modal .mbd{ padding: 16px; color: rgba(247,251,255,.92); }

  .bigPop{
    position: fixed; left: 50%; top: 14%;
    transform: translateX(-50%);
    padding: 12px 18px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.22);
    background: rgba(0,0,0,.30);
    backdrop-filter: blur(8px);
    font-weight: 950; letter-spacing:.3px;
    display:none; z-index: 998;
    box-shadow: 0 18px 45px rgba(0,0,0,.35);
  }
  .bigPop.ok{ color: rgba(34,197,94,.95); }
  .bigPop.bad{ color: rgba(239,68,68,.95); }

  #confetti{
    position: fixed;
    inset: 0;
    width: 100vw;
    height: 100vh;
    pointer-events: none;
    z-index: 1200;
    display:none;
  }
</style>

<!-- 1) EARLY ERROR CAPTURE (runs even if main game script fails) -->
<script>
  window.__LUDO_ERRS__ = [];
  window.__LUDO_BOOT__ = Date.now();

  function __pushErr(label, msg){
    try{
      window.__LUDO_ERRS__.push(label + ": " + msg);
    }catch(_){}
  }

  window.addEventListener("error", function(e){
    __pushErr("JS Error", (e && e.message) ? e.message : String(e));
  });

  window.addEventListener("unhandledrejection", function(e){
    var r = e && e.reason;
    __pushErr("Promise Error", (r && r.message) ? r.message : String(r));
  });
</script>
</head>

<body>
<canvas id="confetti"></canvas>

<div class="wrap" id="app">

  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div style="min-width:0">
        <h1>Cyber Ludo Quiz (Model B) — Hardwired MCQs</h1>
        <p>MCQ screen → Board animation → next MCQ (mobile friendly)</p>
      </div>
    </div>
    <div class="actions">
      <button class="primary" id="btnHow">How to Play</button>
      <button class="danger" id="btnRestart">Restart</button>
    </div>
  </div>

  <div class="card screen active" id="mcqScreen">
    <div class="hd">
      <div>
        <div class="ttl">Quiz Turn</div>
        <div class="sub">Answer MCQ first. Then board animation will be shown.</div>
      </div>
      <button class="good" id="btnSkip">Skip (No Move)</button>
    </div>
    <div class="bd">
      <p class="qText" id="qText">Loading…</p>
      <div class="optGrid" id="opts"></div>
      <div class="errBox" id="errBox"></div>
      <div class="note" style="margin-top:12px">
        Correct → dice rolls and you move • Wrong → computer moves +2
      </div>
    </div>
  </div>

  <div class="card screen" id="boardScreen">
    <div class="hd">
      <div>
        <div class="ttl">Board Animation</div>
        <div class="sub">Classic Ludo-style board (mobile friendly).</div>
      </div>
      <div class="note" id="animHint" style="font-weight:900;color:rgba(247,251,255,.9);">Waiting…</div>
    </div>
    <div class="bd">
      <div class="boardWrap">
        <div class="boardTopInfo">
          <div class="pill">
            <div class="k">Learner</div>
            <div class="v"><span style="color:var(--p1)">●</span> <span id="p1Pos">0</span> / <span id="maxPos">0</span></div>
          </div>
          <div class="pill">
            <div class="k">Computer</div>
            <div class="v"><span style="color:var(--p2)">●</span> <span id="p2Pos">0</span> / <span id="maxPos2">0</span></div>
          </div>
          <div class="pill">
            <div class="k">Dice</div>
            <div class="v"><span class="dice" id="dice">—</span></div>
            <div class="note" id="statusText" style="margin-top:6px">Waiting…</div>
          </div>
        </div>

        <div class="board" id="board">
          <canvas class="boardBg" id="boardBg"></canvas>
          <div class="track" id="track"></div>
          <div class="fxLayer" id="fxLayer"></div>
        </div>

        <div class="note" style="text-align:center">
          Questions answered: <b id="qDone">0</b>/<b id="qTotal">0</b> • Correct: <b id="qCorrect">0</b>
        </div>

      </div>
    </div>
  </div>

</div>

<div class="bigPop" id="bigPop"></div>

<div class="overlay" id="overlay" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="mhd">
      <div class="mt" id="modalTitle">How to Play</div>
      <button id="btnClose">Close</button>
    </div>
    <div class="mbd" id="modalBody"></div>
  </div>
</div>

<!-- 2) MAIN GAME SCRIPT -->
<script>
(function(){
  const errBox = document.getElementById("errBox");
  function showErr(msg){
    if (!errBox) return;
    errBox.style.display = "block";
    errBox.textContent = msg;
  }
  function must(id){
    const el = document.getElementById(id);
    if (!el) throw new Error('Missing element id="' + id + '"');
    return el;
  }
  function escapeHtml(s){
    return String(s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }
  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  const COMPUTER_STEP_ON_WRONG = 2;
  const RETURN_TO_MCQ_DELAY_MS = 1800;
  const SAFE_INDICES = new Set([3, 7, 11, 15, 19]);

  const TRACK_GRID_INDEX = [2,3,4,5,6, 13,20,27,34,41, 46,45,44,43,42, 35,28,21,14,7, 8,9,10,11];
  const FINISH_INDEX = TRACK_GRID_INDEX.length - 1;

  const QUESTIONS = [
    { id:"SMS_LUDO_Q01", q:"Why is using https:// recommended when logging into social networking sites?",
      opts:["It encrypts traffic between your browser and the site","It blocks all ads automatically","It prevents account creation","It makes your posts invisible to the platform"],
      a:0, fb:"HTTPS encrypts data in transit (like passwords and messages), reducing interception risk."
    },
    { id:"SMS_LUDO_Q02", q:"During Facebook setup, what is the safer choice on the “Find Your Friends” step?",
      opts:["Enter your email password so Facebook can import contacts","Skip providing your email password to Facebook","Share your phone contacts publicly","Turn on public search immediately"],
      a:1, fb:"Avoid sharing your email password for contact importing."
    },
    { id:"SMS_LUDO_Q03", q:"Which Facebook feature can alert you if someone logs in from an unfamiliar device?",
      opts:["Public Search","Privacy Shortcuts","Login Notifications","Friend Suggestions"],
      a:2, fb:"Login Notifications can warn you about logins from devices you have not used before."
    },
    { id:"SMS_LUDO_Q04", q:"To reduce exposure in Facebook advertising settings, a recommended choice for “Third Party Sites” is:",
      opts:["Everyone","Friends","Only Me","No-one"],
      a:3, fb:"Setting it to “No-one” reduces third-party advertising association."
    },
    { id:"SMS_LUDO_Q05", q:"If you want your Facebook status updates visible only to your contacts, choose:",
      opts:["Friends Only (or a restricted audience you choose)","Public (everyone)","Friends of friends","Anyone via search engines"],
      a:0, fb:"Use a restricted audience like “Friends Only” for routine posts."
    },
    { id:"SMS_LUDO_Q06", q:"What is a safer practice before posting a photo/video of another person?",
      opts:["Post first and ask later","Get their consent first","Always tag them publicly","Share it only in comments"],
      a:1, fb:"Consent matters because posts can be copied, reshared, and misunderstood later."
    },
    { id:"SMS_LUDO_Q07", q:"Which Twitter setting limits tweets so only approved followers can see them?",
      opts:["Discoverability","Tweet location","Protect your Tweets","Personalization"],
      a:2, fb:"Protecting tweets makes your content visible only to approved followers."
    },
    { id:"SMS_LUDO_Q08", q:"A key risk of linking/auto-posting between multiple social networks is:",
      opts:["It guarantees anonymity everywhere","It always improves privacy","It prevents metadata leaks","You may be anonymous on one site but exposed on another"],
      a:3, fb:"Cross-posting can connect identities across platforms."
    },
    { id:"SMS_LUDO_Q09", q:"Why should you be cautious while sharing photos/videos online (even with privacy settings)?",
      opts:["They can reveal identities and sensitive details like location/time","They always delete automatically","They cannot be copied by others","They are invisible to service providers"],
      a:0, fb:"Images/videos can leak personal information and may be downloaded or reshared."
    },
    { id:"SMS_LUDO_Q10", q:"What is a safer approach to location sharing on social media?",
      opts:["Enable location on every post","Keep location off unless needed and double-check settings","Share live location publicly during travel","Assume location cannot be inferred without GPS"],
      a:1, fb:"Location can reveal routines and real-time presence. Keep it off unless necessary."
    },
    { id:"SMS_LUDO_Q11", q:"If your browser warns about an invalid security certificate while using webmail, it may indicate:",
      opts:["Your inbox is full","Your password is too strong","Possible interception/tampering of the connection","Your account is permanently deleted"],
      a:2, fb:"Certificate warnings can signal a man-in-the-middle risk or misconfigured security."
    },
    { id:"SMS_LUDO_Q12", q:"The chapter compares social networking sites to a “huge party” mainly to suggest that:",
      opts:["Only friends can see your content","Privacy settings fully prevent exposure","Everyone at the party is trustworthy","You may reveal personal details widely without realizing it"],
      a:3, fb:"The metaphor highlights unintended oversharing and broad visibility."
    },
    { id:"SMS_LUDO_Q13", q:"Which email practice reduces malware risk?",
      opts:["Avoid unexpected attachments, especially from unknown senders","Open all attachments quickly to check content","Disable antivirus warnings","Forward suspicious attachments to others"],
      a:0, fb:"Unexpected attachments are a common malware route; verify before opening."
    },
    { id:"SMS_LUDO_Q14", q:"To avoid revealing identity when creating an email account, the guide suggests using:",
      opts:["Your full legal name as username","Anonymity software such as Tor","The same username everywhere","Only your official work email"],
      a:1, fb:"Tor can help hide network identity; also avoid usernames linked to your real identity."
    },
    { id:"SMS_LUDO_Q15", q:"A common sign of an email scam is:",
      opts:["A friendly message that matches an ongoing conversation","A newsletter you subscribed to from a trusted source","An urgent warning asking you to click a link and “verify” or “update” your account","A normal reply that contains no links or requests"],
      a:2, fb:"Scams often create urgency and push you to click links or submit credentials."
    },
    { id:"SMS_LUDO_Q16", q:"A safer response if you receive an unexpected password-reset email is:",
      opts:["Click the link immediately","Reply with your details to confirm","Ignore and continue using the same password","Visit the service by typing the official URL yourself and check account activity"],
      a:3, fb:"Avoid clicking links in suspicious emails; go directly to the official site/app."
    },
    { id:"SMS_LUDO_Q17", q:"Why is it risky to use the same password across social platforms?",
      opts:["One breach can lead to multiple account takeovers (credential reuse)","It prevents password recovery","It forces public posting","It stops you from using HTTPS"],
      a:0, fb:"If one site is compromised, attackers try the same password elsewhere."
    },
    { id:"SMS_LUDO_Q18", q:"What is a safer setting for photo tagging if you want to reduce risk?",
      opts:["Allow everyone to tag you","Do not allow photo tagging / restrict it as much as possible","Enable tagging suggestions","Auto-approve all tags"],
      a:1, fb:"Tagging can expose you and your connections. Restrict or disable if possible."
    },
    { id:"SMS_LUDO_Q19", q:"When installing third-party apps connected to your social accounts, the best first step is to:",
      opts:["Install quickly and decide later","Grant all permissions to avoid errors","Review permissions and avoid apps requesting unnecessary access","Share the app link with everyone"],
      a:2, fb:"App permissions can expose data. Avoid apps requesting more access than needed."
    },
    { id:"SMS_LUDO_Q20", q:"A safe practice to limit oversharing on social media is:",
      opts:["Always keep profiles public","Post travel plans in real time publicly","Share personal identifiers (DOB, address) to build trust","Use privacy settings + think before posting sensitive details"],
      a:3, fb:"Privacy settings help, but judgment before posting is equally important."
    }
  ];

  const mcqScreen = must("mcqScreen");
  const boardScreen = must("boardScreen");
  const qTextEl = must("qText");
  const optsEl = must("opts");
  const trackEl = must("track");
  const fxLayer = must("fxLayer");
  const p1PosEl = must("p1Pos");
  const p2PosEl = must("p2Pos");
  const maxPosEl = must("maxPos");
  const maxPos2El = must("maxPos2");
  const qDoneEl = must("qDone");
  const qTotalEl = must("qTotal");
  const qCorrectEl = must("qCorrect");
  const diceEl = must("dice");
  const statusTextEl = must("statusText");
  const animHintEl = must("animHint");
  const overlay = must("overlay");
  const modalTitle = must("modalTitle");
  const modalBody = must("modalBody");
  const bigPop = must("bigPop");
  const boardBg = must("boardBg");

  must("btnHow").addEventListener("click", showHow);
  must("btnClose").addEventListener("click", hideModal);
  overlay.addEventListener("click", (e) => { if (e.target === overlay) hideModal(); });
  must("btnRestart").addEventListener("click", restart);
  must("btnSkip").addEventListener("click", () => { if (!locked && !gameOver) { popNeutral("Skipped (no movement)"); advanceQuestion(); } });

  maxPosEl.textContent = String(TRACK_GRID_INDEX.length - 1);
  maxPos2El.textContent = String(TRACK_GRID_INDEX.length - 1);

  let qi=0, answered=0, correct=0, p1=0, p2=0, locked=false, gameOver=false;

  buildBoard();
  drawLudoBackground();
  window.addEventListener("resize", drawLudoBackground);

  restart();

  function showScreen(which){
    if (which === "mcq"){
      mcqScreen.classList.add("active");
      boardScreen.classList.remove("active");
    } else {
      boardScreen.classList.add("active");
      mcqScreen.classList.remove("active");
      requestAnimationFrame(drawLudoBackground);
    }
  }

  function buildBoard(){
    trackEl.innerHTML = "";
    for(let i=0;i<49;i++){
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.dataset.grid = String(i);

      const tpos = TRACK_GRID_INDEX.indexOf(i);
      if (tpos !== -1){
        cell.dataset.track = String(tpos);

        if (tpos === 0) cell.classList.add("start");
        if (tpos === TRACK_GRID_INDEX.length - 1) cell.classList.add("finish");
        if (SAFE_INDICES.has(tpos)) cell.classList.add("safe");

        const badge = document.createElement("div");
        badge.className = "badge";
        badge.textContent = (tpos === 0) ? "START" : (tpos === TRACK_GRID_INDEX.length - 1) ? "HOME" : ("#" + tpos);
        cell.appendChild(badge);

        const tokens = document.createElement("div");
        tokens.className = "tokens";
        tokens.innerHTML = '<div class="token t1" style="display:none"></div><div class="token t2" style="display:none"></div>';
        cell.appendChild(tokens);
      }
      trackEl.appendChild(cell);
    }
  }

  function getTrackCell(pos){
    const gridIndex = TRACK_GRID_INDEX[pos];
    return document.querySelector('.cell[data-grid="' + gridIndex + '"]');
  }

  function renderTokens(){
    document.querySelectorAll(".cell[data-track] .token").forEach(t => t.style.display="none");
    const c1 = getTrackCell(p1);
    const c2 = getTrackCell(p2);
    if (c1) c1.querySelector(".t1").style.display = "inline-block";
    if (c2) c2.querySelector(".t2").style.display = "inline-block";
  }

  function updateStats(){
    p1PosEl.textContent = String(p1);
    p2PosEl.textContent = String(p2);
    qDoneEl.textContent = String(answered);
    qCorrectEl.textContent = String(correct);
  }

  function restart(){
    qi=0; answered=0; correct=0; p1=0; p2=0; locked=false; gameOver=false;
    diceEl.textContent = "—";
    fxLayer.innerHTML = "";
    qTotalEl.textContent = String(QUESTIONS.length);
    updateStats();
    renderTokens();
    showScreen("mcq");
    renderQuestion();
  }

  function renderQuestion(){
    if (qi >= QUESTIONS.length){
      showErr("All questions finished. Click Restart.");
      return;
    }
    const Q = QUESTIONS[qi];
    qTextEl.textContent = "Q" + (answered + 1) + ". " + Q.q;

    optsEl.innerHTML = "";
    const letters = ["A","B","C","D"];
    Q.opts.forEach((txt, i) => {
      const btn = document.createElement("button");
      btn.className = "optBtn";
      btn.innerHTML = '<span class="lab">' + letters[i] + '</span><span>' + escapeHtml(txt) + '</span>';
      btn.addEventListener("click", () => choose(i));
      optsEl.appendChild(btn);
    });
  }

  async function choose(i){
    if (locked || gameOver) return;
    locked = true;

    const Q = QUESTIONS[qi];
    const isCorrect = (i === Q.a);
    answered += 1;

    if (isCorrect){
      correct += 1;
      popOK("Correct!");
      const roll = 1 + Math.floor(Math.random()*6);
      showFeedback("Correct ✅", escapeHtml(Q.fb || "Good."), async () => {
        hideModal();
        showScreen("board");
        animHintEl.textContent = "Correct → rolling dice…";
        statusTextEl.textContent = "Rolling…";
        diceEl.classList.add("rolling");

        // quick dice animation
        for (let t=0;t<10;t++){
          diceEl.textContent = String(1 + Math.floor(Math.random()*6));
          await sleep(55);
        }
        diceEl.textContent = String(roll);
        diceEl.classList.remove("rolling");

        animHintEl.textContent = "Moving " + roll + " step(s)…";
        statusTextEl.textContent = "You move " + roll + " step(s).";
        await movePlayerAnimated(1, roll);

        await sleep(RETURN_TO_MCQ_DELAY_MS);
        advanceQuestion();
      });
    } else {
      popBad("Wrong!");
      const corrL = ["A","B","C","D"][Q.a];
      const corrT = Q.opts[Q.a];
      const fb = "Correct answer: " + corrL + " — " + escapeHtml(corrT) + (Q.fb ? ("\n\n" + Q.fb) : "");
      showFeedback("Wrong ❌", fb, async () => {
        hideModal();
        showScreen("board");
        animHintEl.textContent = "Wrong → computer moves +" + COMPUTER_STEP_ON_WRONG;
        statusTextEl.textContent = "Computer moves " + COMPUTER_STEP_ON_WRONG + " step(s).";
        await movePlayerAnimated(2, COMPUTER_STEP_ON_WRONG);

        await sleep(RETURN_TO_MCQ_DELAY_MS);
        advanceQuestion();
      });
    }

    updateStats();
  }

  function advanceQuestion(){
    qi += 1;
    locked = false;
    fxLayer.innerHTML = "";
    renderTokens();
    updateStats();
    showScreen("mcq");
    renderQuestion();
  }

  async function movePlayerAnimated(which, steps){
    const isLearner = (which === 1);
    const trailColor = isLearner ? "rgba(52,211,153,.90)" : "rgba(251,113,133,.90)";

    for(let s=0; s<steps; s++){
      if (isLearner) p1 = Math.min(FINISH_INDEX, p1 + 1);
      else p2 = Math.min(FINISH_INDEX, p2 + 1);

      renderTokens();
      updateStats();

      const posNow = isLearner ? p1 : p2;
      const cell = getTrackCell(posNow);
      if (cell){
        const {x,y} = cellCenterInFxLayer(cell);
        spawnTrail(x, y, trailColor);
        if (SAFE_INDICES.has(posNow)) spawnSpark(x, y);

        const token = cell.querySelector(isLearner ? ".t1" : ".t2");
        if (token){
          token.classList.remove("hop"); void token.offsetWidth; token.classList.add("hop");
        }
      }
      await sleep(170);
    }
  }

  function cellCenterInFxLayer(cellEl){
    const fxRect = fxLayer.getBoundingClientRect();
    const cellRect = cellEl.getBoundingClientRect();
    return {
      x: (cellRect.left + cellRect.width/2) - fxRect.left,
      y: (cellRect.top + cellRect.height/2) - fxRect.top
    };
  }

  function spawnTrail(x, y, color){
    const dot = document.createElement("div");
    dot.className = "trailDot";
    dot.style.left = x + "px";
    dot.style.top = y + "px";
    dot.style.background = "radial-gradient(circle at 35% 35%, rgba(255,255,255,.35), " + color + " 60%, rgba(0,0,0,0) 72%)";
    fxLayer.appendChild(dot);
    setTimeout(() => dot.remove(), 480);
  }

  function spawnSpark(x, y){
    const wrap = document.createElement("div");
    wrap.className = "sparkWrap";
    wrap.style.left = x + "px";
    wrap.style.top = y + "px";
    fxLayer.appendChild(wrap);

    for(let i=0;i<10;i++){
      const s = document.createElement("div");
      s.className = "spark";
      const ang = Math.random() * Math.PI * 2;
      const dist = 18 + Math.random()*18;
      s.style.setProperty("--dx", (Math.cos(ang)*dist) + "px");
      s.style.setProperty("--dy", (Math.sin(ang)*dist) + "px");
      const hue = 38 + Math.floor(Math.random()*25);
      s.style.background = "hsl(" + hue + " 95% 62%)";
      wrap.appendChild(s);
      setTimeout(() => s.remove(), 520);
    }
    setTimeout(() => wrap.remove(), 560);
  }

  function showHow(){
    showModal("How to Play (Model B)",
      "One screen at a time: MCQ → Board animation → next MCQ.\n\n" +
      "Correct: Dice rolls and learner moves step-by-step.\n" +
      "Wrong: Learner does not move, computer moves +" + COMPUTER_STEP_ON_WRONG + ".\n" +
      "Safe squares: spark effect."
    );
  }

  function showFeedback(title, msg, onContinue){
    const html = escapeHtml(msg).replace(/\n/g, "<br/>") +
      '<div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">' +
      '<button class="primary" id="continueBtn">Continue</button></div>';
    showModal(title, html);
    setTimeout(() => {
      const btn = document.getElementById("continueBtn");
      if (btn) btn.addEventListener("click", onContinue);
    }, 0);
  }

  function showModal(title, html){
    modalTitle.textContent = title;
    modalBody.innerHTML = html;
    overlay.style.display = "flex";
  }
  function hideModal(){ overlay.style.display = "none"; }

  function popOK(txt){ showPop(txt, "ok"); }
  function popBad(txt){ showPop(txt, "bad"); }
  function popNeutral(txt){
    bigPop.className = "bigPop";
    bigPop.textContent = txt;
    bigPop.style.display = "block";
    setTimeout(() => bigPop.style.display="none", 850);
  }
  function showPop(txt, cls){
    bigPop.className = "bigPop " + cls;
    bigPop.textContent = txt;
    bigPop.style.display = "block";
    setTimeout(() => bigPop.style.display="none", 650);
  }

  function drawLudoBackground(){
    const rect = boardBg.getBoundingClientRect();
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    boardBg.width = Math.floor(rect.width * dpr);
    boardBg.height = Math.floor(rect.height * dpr);
    const ctx = boardBg.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0);
    const W = rect.width, H = rect.height;
    ctx.clearRect(0,0,W,H);

    const pad = 12;
    const x0 = pad, y0 = pad, w = W - pad*2, h = H - pad*2;
    const halfW = w/2, halfH = h/2;

    ctx.fillStyle = "rgba(255,255,255,1)";
    ctx.fillRect(x0, y0, w, h);

    function fillCorner(x,y,c){
      ctx.fillStyle = c;
      ctx.fillRect(x,y,halfW,halfH);
      const g = ctx.createRadialGradient(x+halfW*0.25,y+halfH*0.25,10,x+halfW*0.25,y+halfH*0.25,Math.max(halfW,halfH));
      g.addColorStop(0,"rgba(255,255,255,0.18)");
      g.addColorStop(1,"rgba(255,255,255,0)");
      ctx.fillStyle = g;
      ctx.fillRect(x,y,halfW,halfH);
    }

    fillCorner(x0,y0,"rgba(22,163,74,0.98)");
    fillCorner(x0+halfW,y0,"rgba(250,204,21,0.98)");
    fillCorner(x0,y0+halfH,"rgba(239,68,68,0.98)");
    fillCorner(x0+halfW,y0+halfH,"rgba(37,99,235,0.98)");

    ctx.fillStyle = "rgba(255,255,255,1)";
    ctx.fillRect(x0 + halfW - w*0.09, y0, w*0.18, h);
    ctx.fillRect(x0, y0 + halfH - h*0.09, w, h*0.18);

    ctx.strokeStyle = "rgba(0,0,0,0.20)";
    ctx.lineWidth = 2;
    ctx.strokeRect(x0,y0,w,h);
  }

})();
</script>

<!-- 3) WATCHDOG: runs even if the main script failed, and shows the reason -->
<script>
(function(){
  function $(id){ return document.getElementById(id); }
  var errBox = $("errBox");
  var qText = $("qText");
  var opts = $("opts");

  // After 1 second, if options are still missing, show diagnostics.
  setTimeout(function(){
    try{
      var noOptions = !opts || opts.children.length === 0;
      var stillLoading = qText && (qText.textContent || "").trim() === "Loading…";

      if (noOptions && stillLoading){
        if (errBox){
          errBox.style.display = "block";
          var msgs = (window.__LUDO_ERRS__ || []);
          var extra =
            "The page is stuck on Loading. This means the new JS did not run on GitHub Pages.\n\n" +
            "Fix steps (do these once):\n" +
            "1) Hard refresh: Ctrl+F5 (Windows) / Cmd+Shift+R (Mac)\n" +
            "2) Open the same URL with ?v=2 at the end (cache bypass)\n" +
            "3) Confirm you replaced the correct index.html in /ludo-updated/\n\n" +
            "Captured errors:\n" + (msgs.length ? ("- " + msgs.join("\n- ")) : "(none captured yet)");

          errBox.textContent = extra;
        }
      }
    } catch(e){
      if (errBox){
        errBox.style.display = "block";
        errBox.textContent = "Watchdog error: " + (e && e.message ? e.message : String(e));
      }
    }
  }, 1000);
})();
</script>

</body>
</html>
